<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- <meta name="viewport" content="width=device-width, user-scalable=no" /> -->
    <title>Image Editor - Spectrum Analysis</title>
    <!-- Load CSS -->
    <link type="text/css" href="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.css" rel="stylesheet">
    <!-- Make sure tui-image-editor.css is loaded BEFORE your custom styles -->
    <link
        type="text/css"
        href="{{ url_for('static', filename='js/tui-image-editor/dist/tui-image-editor.min.css') }}"
        rel="stylesheet">
    <link
        type="text/css"
        href="{{ url_for('static', filename='js/tui-image-editor/css/service-mobile.css') }}"
        rel="stylesheet"
    />
    <style>
      /* Existing styles... */
      .results {
          /* Keep existing styles, but remove 'display: none;' if set */
          margin-top: 0; /* Reset margin if needed inside modal */
          width: 100%;   /* Adjust width if needed inside modal */
      }
      /* ... existing .result-item, img, etc. styles ... */

      /* ADDED: Modal Styles */
      #modal-overlay {
          position: fixed; /* Sit on top of the page content */
          display: none; /* Hidden by default */
          width: 100%; /* Full width (cover the whole page) */
          height: 100%; /* Full height */
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0,0,0,0.6); /* Black background with opacity */
          z-index: 1000; /* Specify a stack order */
          cursor: pointer; /* Add a pointer on hover */
      }

      #results-modal {
          position: fixed;
          display: none; /* Hidden by default */
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 85%; /* Modal width */
          max-width: 800px; /* Max width */
          max-height: 85vh; /* Max height relative to viewport */
          overflow-y: auto; /* Enable scroll if content overflows */
          background-color: #fff;
          padding: 25px;
          border-radius: 8px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          z-index: 1001; /* Higher than overlay */
      }

      #results-modal h2 {
          margin-top: 0;
          margin-bottom: 20px;
          text-align: center;
      }

      #modal-close-button {
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 1.8em;
          line-height: 1;
          color: #888;
          background: none;
          border: none;
          cursor: pointer;
          padding: 0;
      }
      #modal-close-button:hover {
          color: #000;
      }

      /* Ensure results inside modal still use flex */
      #results-modal .results {
          display: flex;
          justify-content: space-around;
          align-items: flex-start;
          flex-wrap: wrap;
      }

      #results-modal .result-item {
           /* Adjustments if needed for modal layout */
           flex-basis: 200px; /* Example base width */
      }
      #results-modal .result-item img {
          max-height: 200px; /* Adjust max height for modal */
      }

      #results-modal .download-links a {
            display: inline-block; /* Allows padding and margins */
            padding: 8px 15px;     /* Vertical and horizontal padding */
            margin-top: 5px;       /* Add some space above the link */
            background-color: #007bff; /* Example blue background */
            color: white;            /* White text */
            border: none;            /* Remove default border */
            border-radius: 4px;      /* Slightly rounded corners */
            text-decoration: none;   /* Remove underline */
            font-size: 0.9em;        /* Adjust font size if needed */
            cursor: pointer;         /* Ensure pointer cursor */
            text-align: center;
            transition: background-color 0.2s ease; /* Smooth hover effect */
        }

        /* Style for hover state */
        #results-modal .download-links a:hover {
            background-color: #0056b3; /* Darker blue on hover */
            color: white;            /* Keep text white */
            text-decoration: none;   /* Ensure no underline on hover */
        }

        /* Style for active (clicked) state */
        #results-modal .download-links a:active {
            background-color: #004085; /* Even darker blue when clicked */
        }

  </style>
  </head>
  <body>
    <!-- Image editor controls - top area -->
    <div class="header">
      <div>
        <!-- Adjust image path -->
        <span class="name">Spectrum image editor</span>
      </div>
      <div class="menu">
        <span class="button">
          <!-- Adjust image path -->
          <img src="{{ url_for('static', filename='img/openImage.png') }}" style="margin-top: 5px" />
          <input type="file" accept="image/*" id="input-image-file" />
        </span>
        <!-- Adjust image paths -->
        <button class="button disabled" id="btn-undo"><img src="{{ url_for('static', filename='img/undo.png') }}" /></button>
        <button class="button disabled" id="btn-redo"><img src="{{ url_for('static', filename='img/redo.png') }}" /></button>
        <button class="button" id="btn-remove-active-object"><img src="{{ url_for('static', filename='img/remove.png') }}" /></button>
        <button class="button" id="btn-download"><img src="{{ url_for('static', filename='img/download.png') }}" /></button>
      </div>
    </div>

    <!-- Image editor area -->
    <!-- Important: Use the class the TUI expects if NOT using includeUI -->
    <div class="tui-image-editor">
        <!-- The canvas will be added here by TUI -->
    </div>

    <div class="tui-image-editor-controls">
        <ul class="scrollable">
          <li class="menu-item">
            <button class="menu-button" id="btn-crop">Crop</button>
            <div class="submenu">
              <button class="btn-prev">&lt;</button>
              <ul class="scrollable">
                <li class="menu-item">
                  <button class="submenu-button" id="btn-apply-crop">Apply</button>
                </li>
              </ul>
            </div>
          </li>
          <li class="menu-item">
            <button class="menu-button">Orientation</button>
            <div class="submenu">
              <button class="btn-prev">&lt;</button>
              <ul class="scrollable">
                <li class="menu-item">
                  <button class="submenu-button" id="btn-rotate-clockwise">Rotate +90</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-rotate-counter-clockwise">Rotate -90</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-flip-x">FilpX</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-flip-y">FilpY</button>
                </li>
              </ul>
            </div>
          </li>
          <li class="menu-item">
            <button class="menu-button" id="btn-draw-line">Drawing</button>
            <div class="submenu">
              <button class="btn-prev">&lt;</button>
              <ul class="scrollable">
                <li class="menu-item">
                  <button class="submenu-button" id="btn-free-drawing">Free<br />Drawing</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-line-drawing">Line<br />Drawing</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-size">Brush<br />Size</button>
                  <div class="hiddenmenu">
                    <input id="input-brush-range" type="range" min="10" max="100" value="50" />
                  </div>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-text-color">Brush<br />Color</button>
                  <div class="hiddenmenu">
                    <div id="tui-brush-color-picker"></div>
                  </div>
                </li>
              </ul>
            </div>
          </li>
          <li class="menu-item">
            <button class="menu-button" id="btn-draw-shape">Shape</button>
            <div class="submenu">
              <button class="btn-prev">&lt;</button>
              <ul class="scrollable">
                <li class="menu-item">
                  <button class="submenu-button" id="btn-add-rect">Rectagle</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-add-square">Square</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-add-ellipse">Ellipse</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-add-circle">Circle</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-add-triangle">Triangle</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-stroke-size">Stroke<br />Size</button>
                  <div class="hiddenmenu">
                    <input id="input-stroke-range" type="range" min="1" max="100" value="10" />
                  </div>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-shape-color">Color</button>
                  <div class="hiddenmenu">
                    <div class="top">
                      <label for="fill-color"
                        ><input
                          type="radio"
                          id="fill-color"
                          name="select-color-type"
                          value="fill"
                          checked="checked"
                        />
                        Fill</label
                      >
                      <label for="stroke-color"
                        ><input
                          type="radio"
                          id="stroke-color"
                          name="select-color-type"
                          value="stroke"
                        />
                        Stroke</label
                      >
                      <label for="input-check-transparent"
                        ><input type="checkbox" id="input-check-transparent" />Transparent</label
                      >
                    </div>
                    <div id="tui-shape-color-picker"></div>
                  </div>
                </li>
              </ul>
            </div>
          </li>
          <li class="menu-item">
            <button class="menu-button">Icon</button>
            <div class="submenu">
              <button class="btn-prev">&lt;</button>
              <ul class="scrollable">
                <li class="menu-item">
                  <button class="submenu-button" id="btn-add-arrow-icon">Arrow<br />Icon</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-add-cancel-icon">Cancel<br />Icon</button>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-icon-color">Color</button>
                  <div class="hiddenmenu">
                    <div id="tui-icon-color-picker"></div>
                  </div>
                </li>
              </ul>
            </div>
          </li>
          <li class="menu-item">
            <button class="menu-button" id="btn-add-text">Text</button>
            <div class="submenu">
              <button class="btn-prev">&lt;</button>
              <ul class="scrollable">
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-size">Size</button>
                  <div class="hiddenmenu">
                    <input id="input-text-size-range" type="range" min="10" max="240" value="120" />
                  </div>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-style">Style</button>
                  <div class="hiddenmenu">
                    <button class="hiddenmenu-button btn-change-text-style" data-style-type="bold">
                      <b>Bold</b>
                    </button>
                    <button class="hiddenmenu-button btn-change-text-style" data-style-type="italic">
                      <i>Italic</i>
                    </button>
                    <button
                      class="hiddenmenu-button btn-change-text-style"
                      data-style-type="underline"
                    >
                      <u>Underline</u>
                    </button>
                  </div>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-align">Align</button>
                  <div class="hiddenmenu">
                    <button class="hiddenmenu-button btn-change-text-style" data-style-type="left">
                      Left
                    </button>
                    <button class="hiddenmenu-button btn-change-text-style" data-style-type="center">
                      Center
                    </button>
                    <button class="hiddenmenu-button btn-change-text-style" data-style-type="right">
                      Right
                    </button>
                  </div>
                </li>
                <li class="menu-item">
                  <button class="submenu-button" id="btn-change-text-color">Color</button>
                  <div class="hiddenmenu">
                    <div id="tui-text-color-picker"></div>
                  </div>
                </li>
              </ul>
            </div>
          </li>
            <!-- ADDED: Analyze Button -->
            <li class="menu-item">
                <button class="menu-button" id="btn-analyze">Analyze</button>
                <!-- No submenu needed for this simple action -->
            </li>
        </ul>
        <!-- <p class="msg">Menu Scrolling <b>Left ⇔ Right</b></p> -->
    </div>

  <!-- ADDED: Modal Structure -->
  <div id="modal-overlay" style="display: none;"></div>
  <div id="results-modal" style="display: none;">
      <button id="modal-close-button">×</button> <!-- Close button -->
      <h2>Analysis Results</h2>
      <div id="modal-content">
          <!-- The existing results structure will be MOVED or replicated here -->
          <div class="results"> <!-- Keep the .results class for styling -->
              <div class="result-item">
                  <h3>2D Spectrum</h3>
                  <img id="spectrum-image" src="" alt="2D Spectrum">
                  <div class="download-links">
                      <a id="download-spectrum" href="#" download>Download Spectrum</a>
                  </div>
              </div>
              <div class="result-item">
                  <h3>45° Profile</h3>
                  <img id="profile-plot" src="" alt="45 Degree Profile">
                  <div class="download-links">
                      <a id="download-profile" href="#" download>Download Profile</a>
                  </div>
              </div>
              <div class="result-item">
                  <h3>Cropped Input</h3>
                  <img id="cropped-image-display" src="" alt="Cropped Region">
                  <div class="download-links">
                      <a id="download-crop" href="#" download>Download Crop</a>
                  </div>
              </div>
          </div>
      </div>
  </div>
  <!-- End Modal Structure -->

    <!-- Load JS Dependencies -->
    <script type="text/javascript" src="https://api-storage.cloud.toast.com/v1/AUTH_e18353c4ea5746c097143946d0644e61/toast-ui-cdn/tui-image-editor/v3.11.0/example/fabric-v4.2.0.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui.code-snippet/v1.5.0/tui-code-snippet.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>


    <script type="text/javascript" src="{{ url_for('static', filename='js/tui-image-editor/dist/tui-image-editor.min.js') }}"></script>

    <!-- This file MUST initialize the editor, e.g., window.imageEditor = new tui.ImageEditor(...) -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/tui-image-editor/js/service-mobile.js') }}"></script>
    
    <!-- 8. ADDED: Analysis Logic Script -->
    <script>
      $(function() {
          // --- Configuration ---
          const analyzeButtonSelector = '#btn-analyze';
          // Remove resultsContainerSelector for the inline version
          // const resultsContainerSelector = '#results-container';
          const loadingIndicatorSelector = '#loading-indicator'; // Keep this if it's in the controls bar

          // --- Modal Selectors ---
          const modalSelector = '#results-modal';
          const overlaySelector = '#modal-overlay';
          const modalCloseButtonSelector = '#modal-close-button';

          // --- Result Elements (now INSIDE the modal) ---
          const spectrumImageSelector = '#results-modal #spectrum-image'; // Target inside modal
          const profilePlotSelector = '#results-modal #profile-plot';
          const croppedImageDisplaySelector = '#results-modal #cropped-image-display';
          const downloadCropLinkSelector = '#results-modal #download-crop';
          const downloadSpectrumLinkSelector = '#results-modal #download-spectrum';
          const downloadProfileLinkSelector = '#results-modal #download-profile';

          // --- Get Editor Instance ---
          const editorInstance = window.imageEditor;
           // Load sample image (Keep if needed)
          const imageUrl = 'https://picsum.photos/200/300';
          if (editorInstance) {
              editorInstance.loadImageFromURL(imageUrl, 'SampleImage').then(function () {
                  if(imageEditor) imageEditor.clearUndoStack();
              });
          } else {
               console.error("Editor instance not found during image load attempt.");
          }


          if (!editorInstance) {
               console.error("TUI Image Editor instance (window.imageEditor) not found. Ensure service-mobile.js initializes it and makes it accessible.");
               $(analyzeButtonSelector).prop('disabled', true).css('opacity', 0.5);
          }

          // --- jQuery Objects ---
          const $analyzeButton = $(analyzeButtonSelector);
          const $loadingIndicator = $(loadingIndicatorSelector).hide();
          // Modal objects
          const $modal = $(modalSelector);
          const $overlay = $(overlaySelector);
          const $modalCloseButton = $(modalCloseButtonSelector);
          // Result objects inside modal
          const $spectrumImage = $(spectrumImageSelector);
          const $profilePlot = $(profilePlotSelector);
          const $croppedImageDisplay = $(croppedImageDisplaySelector);
          const $downloadCropLink = $(downloadCropLinkSelector);
          const $downloadSpectrumLink = $(downloadSpectrumLinkSelector);
          const $downloadProfileLink = $(downloadProfileLinkSelector);

          // --- Function to Close Modal ---
          function closeModal() {
              $modal.fadeOut();
              $overlay.fadeOut();
          }

          // --- Event Listeners ---

          // Analyze Button Click
          $analyzeButton.on('click', function() {
              if (!editorInstance) {
                   alert("Editor not ready for analysis.");
                   return;
              }
              const imageDataUrl = editorInstance.toDataURL();
              if (!imageDataUrl) {
                  alert('Could not get image data. Ensure an image is loaded and cropping is applied if needed.');
                  return;
              }

              // Start Analysis
              $loadingIndicator.show(); // Show loading indicator (e.g., in controls bar)
              $analyzeButton.prop('disabled', true).css('opacity', 0.6);
              // No need to hide inline results anymore
              // $resultsContainer.slideUp();

              // AJAX Call
              $.ajax({
                  url: '/analyze',
                  type: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({ image_data: imageDataUrl }),
                  dataType: 'json'
              })
              .done(function(result) {
                  if (result.status === 'success') {
                      // Update result images and links INSIDE THE MODAL
                      $spectrumImage.attr('src', result.spectrum_url);
                      $profilePlot.attr('src', result.profile_url);
                      $croppedImageDisplay.attr('src', imageDataUrl);

                      $downloadCropLink.attr('href', result.saved_files.crop)
                                       .attr('download', result.saved_files.crop.split('/').pop());
                      $downloadSpectrumLink.attr('href', result.saved_files.spectrum)
                                           .attr('download', result.saved_files.spectrum.split('/').pop());
                      $downloadProfileLink.attr('href', result.saved_files.profile)
                                            .attr('download', result.saved_files.profile.split('/').pop());

                      // Show the modal and overlay
                      $overlay.fadeIn();
                      $modal.fadeIn();
                      // $resultsContainer.slideDown(); // Remove this line

                  } else {
                      alert('Analysis Error: ' + (result.message || 'Unknown server error'));
                  }
              })
              .fail(function(jqXHR, textStatus, errorThrown) {
                  console.error('AJAX Error:', textStatus, errorThrown, jqXHR.responseText);
                  alert('Network or Server Error during analysis. Check console.');
              })
              .always(function() {
                  // Finish Analysis
                  $loadingIndicator.hide();
                  $analyzeButton.prop('disabled', false).css('opacity', 1);
              });
          });

          // Modal Close Button Click
          $modalCloseButton.on('click', function() {
              closeModal();
          });

          // Overlay Click (closes modal)
          $overlay.on('click', function() {
              closeModal();
          });

          // Optional: Close modal on ESC key press
          $(document).on('keydown', function(event) {
              if (event.key === "Escape" || event.key === "Esc") {
                  // Check if modal is visible before closing
                  if ($modal.is(':visible')) {
                       closeModal();
                  }
              }
          });

      }); // End DOM ready
  </script>

  </body>
</html>